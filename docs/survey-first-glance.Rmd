---
title: "survey-first-glance"
author: "Dorien Huijser"
date: "23 maart 2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

This file was last run on: `r as.character(Sys.Date())`.

## Load packages

```{r packages}
# install.packages("data.table")
library(data.table)

# install.packages("tidyverse")
library(tidyverse)

```

## Read the data

This part reads in the raw data export from Qualtrics.

```{r read-data, cache=TRUE}
datafile <- "../data/raw/Data_Privacy_Survey_20220331-3.csv" #-2.csv" # This file has multiple responses in separate columns (so very wide format but tidier)

dppsurvey <- fread(datafile, na.strings = "")

# Skip the first 2 rows as they contain the question text
dppsurvey <- dppsurvey[-c(1, 2), ]

# Skip the previews
dppsurvey <- dppsurvey[-grep("preview",
                             dppsurvey$DistributionChannel), ]

# Convert Duration into numeric variable
dppsurvey$Duration <- as.numeric(dppsurvey$`Duration (in seconds)`)

# Skip unnecessary columns
dppsurvey <- dppsurvey[,-c("StartDate","EndDate","Status","IPAddress", 
                           "Duration (in seconds)", "Finished", "RecordedDate", 
                           "ResponseId", "RecipientLastName", "RecipientFirstName",
                           "RecipientEmail", "ExternalReference", "LocationLatitude",
                           "LocationLongitude", "DistributionChannel", "UserLanguage")]

# Select only consented data
dppsurvey <- dppsurvey %>% 
  filter(Consent == "Yes")

```


## TO DO: 

From wide to long format

```{r}
# Selecting columns, see https://tidyselect.r-lib.org/reference/language.html

# This code does not work :(
dppsurvey_long <- dppsurvey %>%
  pivot_longer(cols = everything(),
               names_to = "variable",
               values_to = "value")

# Example to separate variable column:
dppsurvey_long %>% separate(col = variable, sep = "_", into = c("Variable", "Responsenumber"))

```

## Exploring response numbers

There are currently `r dim(dppsurvey)[1]` survey responses, which took a median time of `r median(dppsurvey$Duration/60)` minutes.

```{r demographics}
# This code works only on the data exports where multiple responses are collapsed into 1 column (which is not tidy)
# Faculties
facultiestable <- dppsurvey %>% 
  count(Faculty, sort=TRUE)

print(facultiestable)

# TODO: some respondents filled out multiple faculties, these responses are saved as 1 (e.g. "medicine, geo") and need to be separated to be added to the count of the relevant faculties (e.g., "medicine", "geo"). This actually happens throughout the survey so a generic solution is needed.

# Graph of respondents per faculty
ggplot(dppsurvey, aes(x= Faculty)) + 
  geom_bar() + 
  labs(x = "Faculty", y = "Number of respondents", title = "Respondents per faculty") + 
  guides(x = guide_axis(angle = 40))

# Positions
positionsperfaculty <- dppsurvey %>%
  group_by(Faculty) %>%
  count(Position)

print(positionsperfaculty)
```

## Interviews

There are currently `r length(dppsurvey$Email_2_TEXT[!is.na(dppsurvey$Email_2_TEXT)])` researchers who have left their email address to be contacted. Below you can find from which faculties they are:

```{r demo-emailpeople}
# Select the people that left their email address
emailpeople <- dppsurvey %>% 
  filter(!is.na(Email_2_TEXT))

# Show which faculties they are from
emailpeople %>% count(Faculty, sort=TRUE)

# Show which positions they are from Positions
emailpeople %>%
  group_by(Faculty) %>%
  count(Position)

emaildataset <- emailpeople %>%
  select(Faculty, Position, Email_address = Email_2_TEXT)

todaysdate <- as.character(Sys.Date())

write.csv(emaildataset, file.path(paste0("../../", todaysdate, "_emailaddresses.csv")))

```

## To Do

- Separate responses if people gave multiple responses so they are counted separately -> Have not yet found a solution for  this.
- Graph for representation of faculties
- Graph for departments in each faculty (panel)
- Rescore data type and personal data type to exclude example text
- Descriptives data type, personal data type, organisational measures, storage medium, consent forms, consent content, dpia experience, dpia help, share outside UU, share measures, data publication, reasonnopub/format publication, know PO, looked for help, found help, sources used, obstacle, challenges,infomissing (text), bettersupport (text)

## Open text responses

There are many questions with open text responses (questions with an "Other, namely" option and Infotools_missing and Better_support variables), which are harder to analyze but extremely important to take into account in the Data Privacy Project

```{r selectopenquestions}
opentextresponses <- dppsurvey %>% 
  select(Faculty, Position, Challenges, Infotools_missing, Better_support_9_TEXT)

write.csv(opentextresponses, file.path(paste0("../data/raw/", todaysdate, "_dppsurvey_opentextresponses.csv")))
```
